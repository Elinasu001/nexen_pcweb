<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>

<%@ taglib prefix="c"      uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn"     uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fmt" 	uri="http://java.sun.com/jsp/jstl/fmt" %>



<%@ page import="com.nexwrms.core.constants.CoreConstants" %>
<%@ page import="com.nexwrms.cfo.com.constants.WebConstants" %>
<%@ page import="com.nexwrms.core.context.AppContext" %>

<script type="text/javascript" src="../js/lib/jquery.bxslider.js"></script>
<script type="text/javascript" src="../js/slider.js"></script>
<link type="text/css" rel="stylesheet" href="../css/jquery.bxslider.css">

	<script type="text/javascript" src="/js/common_ui.js"></script>
	<script type="text/javascript" src="/js/lib/jquery-ui.js"></script>
	<script type="text/javascript" src="/js/lib/jquery.timepicker.min.js"></script>

	<!-- 다음 맵 api -->
	<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=<%=AppContext.getString(WebConstants.KAKAO_MAP_APPKEY)%>&libraries=services"></script>

		<!--subContentsWrap-->
        <div class="subContentsWrap">
            <div class="subContents">
                    <!--mapInfoBox-->
                    <div class="mapInfoBox type02">
                        <div class="mapInfoTop">
                            <!-- 찾기 검색 -->
                            <div class="searchArea">
                                <h3 class="type08">넥센 직영점 찾기</h3>

                                <ul>
                                    <li>
                                        <select class="type04 w130 po_05" title="시/도 선택" onchange="selectSiGunGu();" id="sido">
                                            <option value="">시/도 선택</option>
			                            	<c:forEach var="list" items="${selectSiDoList}" varStatus="status">
			                                    <option value="${list.cdNm }">${list.cdNm }</option>
			                                </c:forEach>
                                        </select>

                                        <select class="type04 w150 po_05" title="시/군/구 선택" id="sigungu" >
                                         <option value="">시/군/구 선택</option>
                                        </select>
                                    </li>
                                    <li><input type="text" name="meajang" class="type08 w100per" id="meajang" title="매장명 입력란" placeholder="매장명을 입력해보세요"></li>
                                </ul>

                                <p class="allView">O2O 서비스 장착 전문점 한눈에 보기 <a href="#" class="goView po_m03 fr" onclick="selectO2o('1');"></a></p>
                            </div>
                            <!-- 찾기 검색 -->

                            <button type="button" class="type01 center w100per" onclick="selectO2oList('1');">
                            	<i class="ico13 po_04"></i>넥센 직영점 찾기
                            </button>

                            <div class="totalBar">
                                <div class="total">total<span id="storeListCnt"></span></div>
                                <!--
                                <a href="#;" class="orderListBtn open" onclick="return false"></a>
                                 -->
                            </div>
                        </div>

                        <div class="mapInfoBottom orderList" style="overflow:auto;">
		                    <div class="type04">
		                        <div class="serResult_01">
		                            <ul id="storeList">
		                            </ul>
		                        </div>
		                    </div>

		                     <div class="pagingFooter">
		                     	<div class="paging" id="pagingMap" style="display:none;"></div>
		                    </div>
                        </div>
                    </div>
                    <!--mapInfoBox-->
             </div>

             <!-- 다음 맵 들어갈 자리 -->
             <div class="mapArea" id="mapDiv">
             </div>
             <!-- 다음 맵 들어갈 자리 -->
		</div>
		<!--subContentsWrap-->

	<!-- layerPopup // -->
	<div class="popupWrap type04 md-modal" id="modal-1"> <!-- md-show -->
		<header class="type03" id="agencyHeader">
		    <!-- agencyHeader -->
		</header>

		<div class="submitAreaWrap type03">
            <!--submitLeft-->
            <div class="submitLeft">
                <div class="submitArea type05">
                    <div class="submit" id="agencyAddr">
                        <!-- agencyAddr Html -->
                    </div>
                </div>
            </div>
            <!--submitLeft-->

            <!--submitRight-->
            <div class="submitRight">
                <div class="submitArea type05">
                    <div class="submit">
                        <label for="tel"><span>전화번호</span></label>
                        <div class="conWrap type07" id="agencyTel">
                            <!-- agencyTel Html -->
                        </div>
                    </div>
                </div>

            </div>
            <!--submitRight-->
        </div>

        <div class="submitAreaWrap type03">
                <div class="submitArea type04 w100per">
                    <div class="submit">
                        <label for="bTime"><span>영업시간</span></label>
                        <div class="conWrap type05" id="agencyBizTime">
                            <!-- agencyBizTime text-->
                        </div>
                    </div>

                    <div class="submit">
                        <label for="items"><span>취급품목</span></label>
                        <div class="conWrap type05">
                            <!--mStateIcon-->
                            <div class="mStateIcon" id="agencyWkTp">
								<!-- agencyWkTp html -->
                            </div>
                            <!--mStateIcon-->
                        </div>
                    </div>
                </div>
        </div>

        <div class="customerState">
            <div class="custInfo">
                <dl>
                    <dt>탈착기</dt>
                    <dd>
                        <div class="info" id="agencyOpt1">
                        </div>
                    </dd>
                </dl>
                <dl>
                    <dt>얼라인먼트</dt>
                    <dd>
                        <div class="info" id="agencyOpt2">
                        </div>

                    </dd>
                </dl>
                <dl>
                    <dt>밸런스</dt>
                    <dd>
                        <div class="info" id="agencyOpt3">
                        </div>
                    </dd>
                </dl>
            </div>
        </div>

        <p class="desc type07">※ 수입차 및 대형 차량의 경우 고급형 장비가 있는 곳에서 교체하시기 바랍니다. </p>

        <div class="mapAreaWrap">
            <!-- map 보이는 영역  width:876px; -->
            <div class="mapView" id="mapDivPopup">

            </div>
            <!-- map 보이는 영역 -->

            <!-- 슬라이드 영역 -->
            <div class="mapSlider">
                <ul id="agencyGall">
                <!--
	                <li>
	                    <a href="#"><img src="../img/customer/m_slider_01.jpg" alt="장착점" /></a>
	                </li>
	                <li>
	                    <a href="#"><img src="../img/customer/m_slider_02.jpg" alt="장착점" /></a>
	                </li>
	                <li>
	                    <a href="#"><img src="../img/customer/m_slider_03.jpg" alt="장착점" /></a>
	                </li>
	                <li>
	                    <a href="#"><img src="../img/customer/m_slider_01.jpg" alt="장착점" /></a>
	                </li>
	                 -->
                </ul>
            </div>
            <!-- 슬라이드 영역 -->
        </div>


    </div>
	<div class="md-overlay"></div>
	<!-- layerPopup // -->

	<script type="text/javascript" src="../js/lib/classie.js"></script>
    <script type="text/javascript" src="../js/lib/modalEffects.js"></script>

    <input type="hidden" name="pageNo"		id="pageNo"	value="${pageNo}"/>		<!-- 현재 페이지 -->
	<input type="hidden" name="pageSize"	id="pageSize" 	value="5" />		<!-- 페이지에 표시할 수 -->
	<input type="hidden" name="pageParam"	id="pageParam" 	value="5" />		<!-- 페이지에 표시할 수 -->

<script type="text/javascript">
var userLoginId = "${userLoginId}";
var agency_CD;
// 전문점찾기 - Start
var pageAddr = "";
var positions = [];
var mapTargetDiv;

//지도 팝업 호출
function callMap(gbn) {
	//현재 내 위치 또는 고정 좌표로 호출
	var myLat = 37.57001757231217; //나의 위치 위도 (기본 위치)
	var myLon = 126.827499331455; //나의 위치 경도 (기본 위치)


	// HTML5의 geolocation으로 사용할 수 있는지 확인합니다
	if(navigator.geolocation) {
	    // GeoLocation을 이용해서 접속 위치를 얻어옵니다
	    navigator.geolocation.getCurrentPosition(function(position) {
	    	myLat = position.coords.latitude, // 위도
	    	myLon = position.coords.longitude; // 경도
		});
	}

	var obj = {
        			title	: "",
        			addr 	: "",
        			lat		: myLat,
        			lon		: myLon,
        			agencyCd : "",
        			};
	positions.push(obj)
	mapTargetDiv = "mapDiv";

	mapDraw(myLon , myLat , "" , positions, "mapDiv");

	//나의 위치 근처 렌탈 전문점 가져오기
 	getRentStore(myLat, myLon);
}

//위도 경도로 주소 가져 오기
function getAddr(result) {
	var addrTxt =  result[0].road_address.address_name;
}

//주소로 거점 재고 체크
//방문 ,픽업
var pageAddr = "";
var detailList = [];	//거점 조회 시 주문 가능일자만 표시 위한 변수
var storechkDay = []; 	//거점 조회 시 주문 가능일자만 표시 위한 변수

//O2O 장착점 한눈에보기
function selectO2o(pageNo){
	var param = {pageNo : pageNo , o2oYn : "Y"};

	$("#meajang").val("");

	$.ajax({
        type: "post",
        url: "/order/o2oList",
        data: JSON.stringify(param),
        contentType:"application/json;charset=UTF-8",  // ajax 통신으로 보내는 타입
        success: function (data) {
        	console.log(data)
        	if(data.rtnCode == "-1") {
        		ComUtil.alert(data.rtnMsg);
        		return;
        	}

        	//리스트 그리기
        	var list = data.list;
        	var listAll = data.listAll;
        	var pageCommon = data.pageCommon;
        	var html = "";
        	var exCnt = 0; // O40521142, O40521134, O40521145 3개 영업소 넥센직영점 검색 안되도록 제외, 쿼리 수정없이 하기 위한 임시 변수 생성
			// 총 갯수 계산을 위해 필요
        	var positions = [];
    		for(var i=0; i<listAll.length; i++) {
    			var obj = {
	        			title	: listAll[i].bhfNm,
	        			addr 	: listAll[i].addr,
	        			lat		: listAll[i].lat,
	        			lon		: listAll[i].lon,
	        			agencyCd : listAll[i].agencyCd,
	        			};
    			positions.push(obj);
    		}
    		html += "<li class='storeAll'>";
    		 html += "</li>";
    		for(var i=0; i<list.length; i++) {
    			if(list[i].bhfCd != "O40521142" && list[i].bhfCd != "O40521134" && list[i].bhfCd != "O40521145") {
    			html += "<li class='storeList"+i+"'>";
	    		html += "<div class='storeList'>";
	    		html += "    <ul>";
	    		html += "        <li id='nmClick' data-num='" + i + "' data-lon='" + list[i].lon + "' data-lat='" + list[i].lat +"'>"+list[i].bhfNm+"</li>";
	    		html += "        <li>"+list[i].addr+"</li>";
	    		/* html += "        <li>수입차 경정비 가능</li>"; */
	    		html += "    </ul>";
	    		html += "    <div class='mStateIcon'>";
	    		html += "        <div class='state'>";
	    		html += "            <img src='/img/common/state_ico02.png'  alt='타이어'/>";
	    		html += "            <span>타이어</span>";
	    		html += "        </div>";
	    		if(list[i].chYn == "Y") {
		    		html += "        <div class='state'>";
		    		html += "            <img src='/img/common/state_ico01.png'  alt='추천'/>";
		    		html += "            <span>추천</span>";
		    		html += "        </div>";
	    		}
	    		if(list[i].cwYn == "Y") {
		    		html += "        <div class='state'>";
		    		html += "            <img src='/img/common/state_ico05.png'  alt='세차'/>";
		    		html += "            <span>세차</span>";
		    		html += "        </div>";
	    		}
	    		if(list[i].fmYn == "Y") {
		    		html += "        <div class='state'>";
		    		html += "            <img src='/img/common/state_ico06.png'  alt='1급정비'/>";
		    		html += "            <span>1급정비</span>";
		    		html += "        </div>";
	    		}
	    		if(list[i].lmYn == "Y") {
		    		html += "        <div class='state'>";
		    		html += "            <img src='/img/common/state_ico03.png'  alt='경정비'/>";
		    		html += "            <span>경정비</span>";
		    		html += "        </div>";
	    		}
	    		if(list[i].seasonGbn == "02") {
		    		html += "        <div class='state'>";
		    		html += "            <img src='/img/common/state_ico04.png'  alt='겨울용'/>";
		    		html += "            <span>겨울용</span>";
		    		html += "        </div>";
	    		}
                html += "    </div>";
                html += "    <button type='button' class='type18' onClick='goFind(\""+list[i].bhfNm+"\", \""+list[i].lat+"\", \""+list[i].lon+"\");'>길찾기<i class='ico15 po_10 fr'></i></button>";
                html += "    <button type='button' class='type18' onClick='fn_searchAgencyInfo(\""+list[i].agencyCd+"\");'>상세보기<i class='ico15 po_10 fr'></i></button>";
                html += "</div>";
                html += "</li>";
				
    			} else {
//         			exCnt += 1;
        		}
    		}

    		//지도 그리기 - 조회 된 위치 중 가장 가까운 좌표로 그린다.
    		mapTargetDiv = "mapDiv";
    		mapDraw(list[0].lon , list[0].lat, list[0].bhfNm , positions,"mapDiv");

    		$("#storeList").empty();
			$("#storeList").html(html);
			$("#storeListCnt").html(pageCommon.totalCount - Number(exCnt));

			$("#pageNo").val(pageNo);
			PageUtil.fnPageMakeDisplay(pageCommon.totalCount - Number(exCnt), $("#pageNo").val() , $("#pagingMap") , "selectO2o", 5);
        },
        error: function(xhr,status,error){
        	//ComUtil.alert(support0014);
        }
    });
}

function selectO2oList(pageNo) {
	var sido = $("#sido").val();
	var meajang = $("#meajang").val();
	
	if(meajang == "" && sido == "") {
		alert("시도 정보 또는 매장명을 입력 하세요.");
		return false;
	}
	
	var param = {searchClCd : $("#sido").val() ,  searchPtnCd : $("#sigungu option:checked").text() , searchKeyword : $("#meajang").val() , pageNo : pageNo , o2oYn : "Y"};
	
// 	$("#meajang").val("");

	$.ajax({
        type: "post",
        url: "/order/o2oList",
        data: JSON.stringify(param),
        contentType:"application/json;charset=UTF-8",  // ajax 통신으로 보내는 타입
        success: function (data) {
        	console.log(data)
        	if(data.rtnCode == "-1") {
        		ComUtil.alert(data.rtnMsg);
        		return;
        	}

        	//리스트 그리기
        	var list = data.list;
        	var listAll = data.listAll;
        	var pageCommon = data.pageCommon;
        	var html = "";
        	var exCnt = 0; // O40521142, O40521134, O40521145 3개 영업소 넥센직영점 검색 안되도록 제외, 쿼리 수정없이 하기 위한 임시 변수 생성
			// 총 갯수 계산을 위해 필요

        	var positions = [];
        	for(var i=0; i<listAll.length; i++) {
        		 var obj = {
		        			title	: listAll[i].bhfNm,
		        			addr 	: listAll[i].addr,
		        			lat		: listAll[i].lat,
		        			lon		: listAll[i].lon,
		        			agencyCd : listAll[i].agencyCd,
		        			};
	    			positions.push(obj);
	    			
	    			//지도 그리기 - 조회 된 위치 중 가장 가까운 좌표로 그린다.
		    		mapTargetDiv = "mapDiv";
		    		mapDraw(listAll[0].lon , listAll[0].lat, listAll[0].bhfNm , positions,"mapDiv");
        	}
        	if(list.length > 0 ) {
	    		for(var i=0; i<list.length; i++) {
	    			if(list[i].bhfCd != "O40521142" && list[i].bhfCd != "O40521134" && list[i].bhfCd != "O40521145") {
		    		html += "<li class='storeList"+i+"'>";
		    		html += "<div class='storeList'>";
		    		html += "    <ul>";
		    		html += "        <li id='nmClick' data-num='" + i + "' data-lon='" + list[i].lon + "' data-lat='" + list[i].lat +"'>"+list[i].bhfNm+"</li>";
		    		html += "        <li>"+list[i].addr+"</li>";
		    		/* html += "        <li>수입차 경정비 가능</li>"; */
		    		html += "    </ul>";
		    		html += "    <div class='mStateIcon'>";
		    		html += "        <div class='state'>";
		    		html += "            <img src='/img/common/state_ico02.png'  alt='타이어'/>";
		    		html += "            <span>타이어</span>";
		    		html += "        </div>";
		    		if(list[i].chYn == "Y") {
			    		html += "        <div class='state'>";
			    		html += "            <img src='/img/common/state_ico01.png'  alt='추천'/>";
			    		html += "            <span>추천</span>";
			    		html += "        </div>";
		    		}
		    		if(list[i].cwYn == "Y") {
			    		html += "        <div class='state'>";
			    		html += "            <img src='/img/common/state_ico05.png'  alt='세차'/>";
			    		html += "            <span>세차</span>";
			    		html += "        </div>";
		    		}
		    		if(list[i].fmYn == "Y") {
			    		html += "        <div class='state'>";
			    		html += "            <img src='/img/common/state_ico06.png'  alt='1급정비'/>";
			    		html += "            <span>1급정비</span>";
			    		html += "        </div>";
		    		}
		    		if(list[i].lmYn == "Y") {
			    		html += "        <div class='state'>";
			    		html += "            <img src='/img/common/state_ico03.png'  alt='경정비'/>";
			    		html += "            <span>경정비</span>";
			    		html += "        </div>";
		    		}
		    		if(list[i].seasonGbn == "02") {
			    		html += "        <div class='state'>";
			    		html += "            <img src='/img/common/state_ico04.png'  alt='겨울용'/>";
			    		html += "            <span>겨울용</span>";
			    		html += "        </div>";
		    		}
	                html += "    </div>";
	                html += "    <button type='button' class='type18' onClick='goFind(\""+list[i].bhfNm+"\", \""+list[i].lat+"\", \""+list[i].lon+"\");'>길찾기<i class='ico15 po_10 fr'></i></button>";
	                html += "    <button type='button' class='type18' onClick='fn_searchAgencyInfo(\""+list[i].agencyCd+"\");'>상세보기<i class='ico15 po_10 fr'></i></button>";
	                html += "</div>";
	                html += "</li>";
	    			
	    			} else {
// 	        			exCnt += 1;
	        			html += "<li>";
	    	    		html += "<div class='storeList'>";
	    	    		html += "    <ul>";
	    	    		html += "		<li>조회된 전문점이 없습니다.</li>";
	    	    		html += "    </ul>";
	    	    		html += "</div>";
	    	    		html += "</li>";
	           			$("#storeList").html(html);
	    				$("#storeListCnt").html("0");
	        		}
	    		}
	
	    		$("#storeList").empty();
				$("#storeList").html(html);
				$("#storeListCnt").html(pageCommon.totalCount - Number(exCnt));
	
				$("#pageNo").val(pageNo);
				PageUtil.fnPageMakeDisplay(pageCommon.totalCount - Number(exCnt), $("#pageNo").val() , $("#pagingMap") , "selectO2oList", 5);

        	} else {
	    		html += "<li>";
	    		html += "<div class='storeList'>";
	    		html += "    <ul>";
	    		html += "		<li>조회된 전문점이 없습니다.</li>";
	    		html += "    </ul>";
	    		html += "</div>";
	    		html += "</li>";
       			$("#storeList").html(html);
				$("#storeListCnt").html("0");
       		}

        },
        error: function(xhr,status,error){
        	//ComUtil.alert(support0014);
        }
    });
}

function selectStore(pageNo){

	var sido = $("#sido").val();
	var meajang = $("#meajang").val();

	if(ValidUtil.isEmpty(sido) && ValidUtil.isEmpty(meajang)) {
		ComUtil.alert("시도 정보 또는 매장명을 입력 하세요.");
		return false;
	}

	$(".totalBar").hide();
	// searchClCd : 시  - sido
	// searchPtnCd : 시군구  - sigungu
	// searchFm : 수입차
	// searchKeyword : 검색어  - meajang
	// pageIndex : 페이지 번호
	if(agency_CD !=null)
		var param = {searchClCd : $("#sido").val() ,  searchPtnCd : $("#sigungu").val() ,agencyCd : agency_CD , pageNo : pageNo};
	else
		var param = {searchClCd : $("#sido").val() ,  searchPtnCd : $("#sigungu").val() ,searchKeyword : $("#meajang").val(), pageNo : pageNo};

	$.ajax({
        type: "post",
        url: "/order/rentalList",
        data: JSON.stringify(param),
        contentType:"application/json;charset=UTF-8",  // ajax 통신으로 보내는 타입
        success: function (data) {
        	console.log("rentalList:::");
        	console.log(data);

        	if(data.rtnCode == "-1") {
        		alert(data.rtnMsg);
        		return;
        	}
       		var list = data.rtnList;

    		var html = "";
       		if(list.length > 0 ) {
	        	//페이지용
            	$(".totalBar").show();
            	positions = [];
            	for(var i=0; i<list.length; i++) {
		    		html += "<li>";
		    		html += "<div class='storeList'>";
		    		html += "    <ul>";
		    		html += "        <li id='nmClick' data-num='" + i + "' data-lon='" + list[i].posY + "' data-lat='" + list[i].posX +"'>"+list[i].agencyNm+"</li>";
		    		html += "        <li>"+list[i].city + " " +list[i].street+"</li>";
		    		/* html += "        <li>수입차 경정비 가능</li>"; */
		    		html += "    </ul>";
		    		html += "    <div class='mStateIcon'>";
		    		html += "        <div class='state'>";
		    		html += "            <img src='/img/common/state_ico02.png'  alt='타이어'/>";
		    		html += "            <span>타이어</span>";
		    		html += "        </div>";
		    		if(list[i].chYn == "Y") {
			    		html += "        <div class='state'>";
			    		html += "            <img src='/img/common/state_ico01.png'  alt='추천'/>";
			    		html += "            <span>추천</span>";
			    		html += "        </div>";
		    		}
		    		if(list[i].cwYn == "Y") {
			    		html += "        <div class='state'>";
			    		html += "            <img src='/img/common/state_ico05.png'  alt='세차'/>";
			    		html += "            <span>세차</span>";
			    		html += "        </div>";
		    		}
		    		if(list[i].fmYn == "Y") {
			    		html += "        <div class='state'>";
			    		html += "            <img src='/img/common/state_ico05.png'  alt='1급정비'/>";
			    		html += "            <span>1급정비</span>";
			    		html += "        </div>";
		    		}
		    		if(list[i].lmYn == "Y") {
			    		html += "        <div class='state'>";
			    		html += "            <img src='/img/common/state_ico03.png'  alt='경정비'/>";
			    		html += "            <span>경정비</span>";
			    		html += "        </div>";
		    		}
		    		if(list[i].seasonGbn == "02") {
			    		html += "        <div class='state'>";
			    		html += "            <img src='/img/common/state_ico04.png'  alt='겨울용'/>";
			    		html += "            <span>겨울용</span>";
			    		html += "        </div>";
		    		}
	                html += "    </div>";
	              	//조직코드 , 주소 , 우편 번호 , 상세 인덱스
	                /* html += "    <button type='button' class='type18' onClick='storeFix(\""+list[i].agencyCd+"\", \""+list[i].agencyNm+"\", \""+list[i].city + " " +list[i].street+"\", \""+list[i].salesGroup+"\", \""+list[i].salesOffice+"\" , \""+i+"\");'>위치가기<i class='ico15 po_03 fr'></i></button>"; */
	                html += "    <button type='button' class='type18' onClick='goFind(\""+list[i].agencyNm+"\", \""+list[i].posX+"\", \""+list[i].posY+"\");'>길찾기<i class='ico15 po_10 fr'></i></button>";
	                html += "    <button type='button' class='type18' onClick='fn_searchAgencyInfo(\""+list[i].agencyCd+"\");'>상세보기<i class='ico15 po_10 fr'></i></button>";
	                html += "</div>";
	                html += "</li>";

	                var obj = {
		        			title	: list[i].agencyNm,
		        			addr 	: list[i].city + " " +list[i].street,
		        			lat		: list[i].posX,
		        			lon		: list[i].posY,
		        			agencyCd : list[i].agencyCd,
		        			flag : "one"
		        			};

	    			positions.push(obj);
	    		}

				$("#storeList").empty();
				$("#storeList").html(html);
				$("#storeListCnt").html(list.length);

				var pageCommon = data.pageCommon;
				PageUtil.fnPageMakeDisplay(list.length, $("#pageNo").val() , $("#pagingMap") , "selectStorePage", 10);

				//지도 그리기 - 조회 된 위치 중 가장 가까운 좌표로 그린다.
				mapTargetDiv = "mapDiv";
				
	        	mapDraw(list[0].posY , list[0].posX, list[0].agencyNm , positions, "mapDiv");
       		} else {
	    		html += "<li>";
	    		html += "<div class='storeList'>";
	    		html += "    <ul>";
	    		html += "		<li>조회된 전문점이 없습니다.</li>";
	    		html += "    </ul>";
	    		html += "</div>";
	    		html += "</li>";
       			$("#storeList").html(html);
				$("#storeListCnt").html("0");
       		}
        },
        error: function(xhr,status,error){
        	//alert(support0014);
        }
    });
}

//지도 그리기
function mapDraw(lon , lat , bhfNm , positions, mapId){
	var agencyLat 	= lat; 	//대리점의 위도
	var agencyLon 	= lon; 	//대리점의 경도
	var agencyBhfNm	= bhfNm;

    //var mapContainer = document.getElementById('mapDiv'), // 지도를 표시할 div
    var mapContainer = document.getElementById(mapId), // 지도를 표시할 div
    mapOption = {
        center: new daum.maps.LatLng(agencyLat, agencyLon), // 지도의 중심좌표
        level: 9 // 지도의 확대 레벨
    };
	map = new daum.maps.Map(mapContainer, mapOption); // 지도를 생성합니다

    // 마커를 생성합니다
	var imageSrc = "/img/common/map_ico.png";
	if(positions[0].flag == 'one') {
		imageSrc = "/img/common/map_ico_03.png";
	}
	
    var imageSize = new daum.maps.Size(50, 65);
    for (var i = 0; i < positions.length; i ++) {

        var marker = new kakao.maps.Marker({
            map: map, // 마커를 표시할 지도
            position: new daum.maps.LatLng(positions[i].lat, positions[i].lon), // 마커를 표시할 위치
            title : positions[i].title, // 마커의 타이틀, 마커에 마우스를 올리면 타이틀이 표시됩니다
            image : new daum.maps.MarkerImage(imageSrc, imageSize) // 마커 이미지
        	,clickable: true
        });
        markerInfo[i] = marker;
        infoWindow(marker, positions[i].title, i,'','','','',positions[i].agencyCd);
    }

}
// 전문점찾기 - End


	function infoWindow(marker, agencyBhfNm, tel_no, rep_nm, city, street, addr3, agency_cd, salesGroup, salesOffice, pos_cd){
		// 마커를 클릭했을 때 마커 위에 표시할 인포윈도우를 생성합니다
	    var iwContent = '<div style="padding:2px;"><span style="font-weight:bold;">영업점명 </span> : '+agencyBhfNm+'</div>'
/*
	    				+'<div style="padding:2px;"><span style="font-weight:bold;">전화번호 </span> : '+tel_no+'</div>'
	    				+'<div style="padding:2px;"><span style="font-weight:bold;">주소 </span> : '+ city + street + '('+ addr3 +')</div>'
	    				+'<div style="padding:2px;"><span style="font-weight:bold;">대표자 </span> : '+rep_nm+'</div>'
 */
	    				,iwRemoveable = true;// removeable 속성을 ture 로 설정하면 인포윈도우를 닫을 수 있는 x버튼이 표시됩니다
/*
	 	// 인포윈도우를 생성합니다
	    var infowindow = new daum.maps.InfoWindow({
	        content : iwContent,
	        removable : iwRemoveable
	    });

	 	// 마커에 클릭이벤트를 등록합니다
	    daum.maps.event.addListener(marker, 'mouseover', function() {
	          // 마커 위에 인포윈도우를 표시합니다
	          infowindow.open(map, marker);
	    });

	 	// 마커에 마우스아웃 이벤트를 등록합니다
	    daum.maps.event.addListener(marker, 'mouseout', function() {
	        // 마커에 마우스아웃 이벤트가 발생하면 인포윈도우를 제거합니다
	        infowindow.close();
	    });
 */
	 	// 마커에 클릭이벤트를 등록합니다
	 	if(agencyBhfNm!=""){
	    	daum.maps.event.addListener(marker, 'click', function() {
		        // 마커 위에 인포윈도우를 표시합니다
// 		        $("#meajang").val(agencyBhfNm);
		        agency_CD = agency_cd;
				//parent.setRentalInf(city, street, agency_nm, addr3, agency_cd, salesGroup, salesOffice, tel_no, pos_cd);
				var normalImage = new kakao.maps.MarkerImage(
	        		'/img/common/map_ico.png',
	        		new kakao.maps.Size(50, 65));
				var markerImage = new kakao.maps.MarkerImage(
	        		'/img/common/map_ico_03.png',
	        		new kakao.maps.Size(50, 65));
	
	            if (!selectedMarker || selectedMarker !== marker) {
	                // 클릭된 마커 객체가 null이 아니면 클릭된 마커의 이미지를 기본 이미지로 변경하고
	                if(!!selectedMarker) {
	                	selectedMarker.setImage(normalImage);
	                }
	                // 현재 클릭된 마커의 이미지는 클릭 이미지로 변경합니다
	                marker.setImage(markerImage);
	            } 
	            // 클릭된 마커를 현재 클릭된 마커 객체로 설정합니다
	            selectedMarker = marker;
	            map.setLevel('5');
	            var moveLatLon = new kakao.maps.LatLng(marker.getPosition().getLat(), marker.getPosition().getLng());
	        	map.panTo(moveLatLon);
	        	
// 	        	$('.storeList'+tel_no).prependTo('.serResult_01');
	    	});
		}
		selectedMarker = null;
		agency_CD=null;
	}

//시도 셀렉트 선택 시 시군구 조회
function selectSiGunGu(){
	var sido = $("#sido").val();

	if (ValidUtil.isEmpty(sido)) {
		$("#sigungu").empty();
		return false;
	}

	$.ajax({
	    url: "/order/selectSiGunGu",
	    type: "GET",
	    data: {param : $("#sido").val()},
	    success: function(data) {
	    	console.log(data)
	    	var html = "";
		    	html += "<option value=''>전체</option>";
	    	for(var i=0; i<data.length; i++) {
	    		html += "<option value='"+data[i].cd+"'>" + data[i].cdNm + "</option>";
	    	}

	    	$("#sigungu").html(html);
	    },
	    error: function (request, status, error) {
	    	console.log(error)
		}
	});
}

/* 길찾기 */
function goFind(agencyNm, posX, posY){
	window.open("http://map.daum.net/link/to/"+agencyNm+","+posX+","+posY);
}

function fn_searchAgencyInfo(agencyCd) {
	var pUrl = "/order/rentalAgencyInfo";

	var pParams = {
		agencyCd : agencyCd
	};

	console.log("fn_searchAgencyInfo rentalAgencyInfo !!!");
	console.log(pParams);
	cfnSendRequest(pUrl,pParams,'rentalAgencyInfo');

}

$(document).ready(function() {

	//evManager.init();
});

var selectedMarker = null; // 마커 변경을 위해
var markerInfo = new Array();

// $(document).on('click', '.storeList>ul>li', function () {
//     $(this).appendTo('.storeList>ul');
//     sortLi('.storeList');
//   });

$(document).on("click", "#nmClick", function() {
	var lon= $(this).attr('data-lon');
	var lat= $(this).attr('data-lat');
	var num= $(this).attr('data-num');
	numImg = parseInt(num) + (($("#pageNo").val()-1) *5);
	
	var moveLatLon = new kakao.maps.LatLng(lat, lon);
	
	var normalImage = new kakao.maps.MarkerImage(
		'/img/common/map_ico.png',
		new kakao.maps.Size(50, 65));
	var markerImage = new kakao.maps.MarkerImage(
		'/img/common/map_ico_03.png',
		new kakao.maps.Size(50, 65));
	
	if (!selectedMarker || selectedMarker !== markerInfo[numImg]) {
		// 클릭된 마커 객체가 null이 아니면 클릭된 마커의 이미지를 기본 이미지로 변경하고
		if(!!selectedMarker) {
			selectedMarker.setImage(normalImage);
		}
		// 현재 클릭된 마커의 이미지는 클릭 이미지로 변경합니다
		markerInfo[numImg].setImage(markerImage);
	} 
	// 클릭된 마커를 현재 클릭된 마커 객체로 설정합니다
	selectedMarker = markerInfo[numImg];

	// 마커가 지도 위에 표시되도록 설정합니다
	markerInfo[numImg].setMap(map);  
	// 지도 중심을 이동 시킵니다
	map.setLevel('5');
	map.panTo(moveLatLon);

	$('.storeList'+num).prependTo('.storeAll');
});

callMap("1");

/*
 * 리퀘스트 후처리 함수 - SUCCESS
 */
function cfnRequestSuccessCallback(callback, result) {
	if(result.rtnCode == 0) {
		if (callback == 'rentalAgencyInfo') {
			var html = "";
			html += "<h2>";
			html += result.rtnList[0].agencyNm;
			html += "<span class='icoArea'>";
			if(result.rtnList[0].chYn == "Y") {
				html += "	<img src='../img/common/state_big_ico01.png' alt='추천'> ";
			}
			html += "   <img src='../img/common/state_big_ico02.png' alt='타이어'>";
			html += "</span>";
			html += "<a href='#' onclick='javascript:fn_popupClose();' class='layPopClose'></a>";
			$("#agencyHeader").empty();
			$("#agencyHeader").html(html);

            // 주소정보
			html = "";
			html += "<label for='address'><span>주소</span></label>";
			html += "<div class='conWrap type06' >";
            html += result.rtnList[0].city + " " +result.rtnList[0].street;
            html += "</div>";
            html += "<button type='button' class='type18' onClick='goFind(\""+result.rtnList[0].agencyNm+"\", \""+result.rtnList[0].posX+"\", \""+result.rtnList[0].posY+"\");'>길찾기<i class='ico15 po_10 fr'></i></button>";
			$("#agencyAddr").html(html);

            // 전화번호
			$("#agencyTel").text(phoneFomat(result.rtnList[0].telNo));

            // 영업시간
			$("#agencyBizTime").text(result.rtnList[0].agencyBizTime);

            // 취급품목
			html = "";
			html += "        <div class='state'>";
			html += "            <img src='/img/common/state_ico02.png'  alt='타이어'/>";
			html += "            <span>타이어</span>";
			html += "        </div>";
			if(result.rtnList[0].chYn == "Y") {
				html += "        <div class='state'>";
				html += "            <img src='/img/common/state_ico01.png'  alt='추천'/>";
				html += "            <span>추천</span>";
				html += "        </div>";
			}
			if(result.rtnList[0].cwYn == "Y") {
				html += "        <div class='state'>";
				html += "            <img src='/img/common/state_ico05.png'  alt='세차'/>";
				html += "            <span>세차</span>";
				html += "        </div>";
			}
			if(result.rtnList[0].fmYn == "Y") {
				html += "        <div class='state'>";
				html += "            <img src='/img/common/state_ico05.png'  alt='1급정비'/>";
				html += "            <span>1급정비</span>";
				html += "        </div>";
			}
			if(result.rtnList[0].lmYn == "Y") {
				html += "        <div class='state'>";
				html += "            <img src='/img/common/state_ico03.png'  alt='경정비'/>";
				html += "            <span>경정비</span>";
				html += "        </div>";
			}
			if(result.rtnList[0].seasonGbn == "02") {
				html += "        <div class='state'>";
				html += "            <img src='/img/common/state_ico04.png'  alt='겨울용'/>";
				html += "            <span>겨울용</span>";
				html += "        </div>";
			}
            $("#agencyWkTp").html(html);


            // 탈착기
            if (!ValidUtil.isEmpty(result.rtnList[0].desorptNm)){
	            html = "";
	            html +="<span>"+result.rtnList[0].desorptNm+"</span>";
	            $("#agencyOpt1").html(html);
            }

            // 얼라이먼트
            if (!ValidUtil.isEmpty(result.rtnList[0].alignNm)){
	            html = "";
	            html +="<span>"+result.rtnList[0].alignNm+"</span>";
	            $("#agencyOpt2").html(html);
            }

            // 밸런스
            if (!ValidUtil.isEmpty(result.rtnList[0].balanceNm)){
	            html = "";
	            html +="<span>"+result.rtnList[0].balanceNm+"</span>";
	            $("#agencyOpt3").html(html);
            }

            // 이미지
		    html = "";
            for(var j=0; j < result.acyFileList.length; j++) {
	            if (!ValidUtil.isEmpty(result.acyFileList[j].atflPathNm)){
		            html +="<li>";
		            html +="	<a href='#'>";
		            html +="		<img src='<%=AppContext.getString(WebConstants.FileDir.IMGFILE_RENTAL_URL)%>/atfile_cms/agency/"+result.acyFileList[j].atflPathNm+"' alt='장착점' />";
		            html +="	</a>";
		            html +="</li>";
	            }
            }
            //<li><img src="/atfile_cms/agency/${acyFileList.atflPathNm}" alt="" /></li>
            if (result.acyFileList.length == 0) {
            	html += "<li>";
            	html += "<a href='#'><img src='../img/customer/m_slider_01.jpg' alt='장착점' /></a>";
            	html += "</li>";
            	html += "<li>";
            	html += "<a href='#'><img src='../img/customer/m_slider_02.jpg' alt='장착점' /></a>";
            	html += "</li>";
            	html += "<li>";
            	html += "<a href='#'><img src='../img/customer/m_slider_03.jpg' alt='장착점' /></a>";
            	html += "</li>";
            	html += "<li>";
            	html += "<a href='#'><img src='../img/customer/m_slider_01.jpg' alt='장착점' /></a>";
            	html += "</li>";
            }

		    $("#agencyGall").html(html);
		    $("#agencyGall").addClass("bxslider4");

		    var bx4 = $('.bxslider4').bxSlider({
		    	mode : 'vertical',
				 slideWidth: 210,
				 slideMargin: 1,
				 minSlides: 3,
				 maxSlides: 3,
				 moveSlides: 1,
				 pager:false
		    });
		    //bx4.reloadSlider();




		    positions = [];
            var obj = {
            		title	: result.rtnList[0].agencyNm,
            		addr 	: result.rtnList[0].city + " " +result.rtnList[0].street,
            		lat		: result.rtnList[0].posX,
            		lon		: result.rtnList[0].posY
            };
            positions.push(obj);
            mapTargetDiv = "mapDivPopup";
            mapDraw(result.rtnList[0].posY , result.rtnList[0].posX, result.rtnList[0].agencyNm , positions, "mapDivPopup");

            getRentStore(result.rtnList[0].posX,result.rtnList[0].posY);

			$("#modal-1").addClass("md-show");
			$('body').addClass('bgFix');

		} else if (callback == 'selectAroundRentalStoreMap') {
			// selectAroundRentalStoreMap
	        var obj;
            for(var j=0; j < result.rtnList.length; j++) {
	            obj = {
	            		title	: result.rtnList[j].agencyNm,
	            		addr 	: result.rtnList[j].city + " " +result.rtnList[j].street,
	            		lat		: result.rtnList[j].posX,
	            		lon		: result.rtnList[j].posY,
	            };
	            positions.push(obj);
            }
            console.log("mapTargetDiv::" + mapTargetDiv);
            if (result.rtnList.length > 0) {
            	if(mapTargetDiv == "mapDiv") {
	            	mapDraw(result.rtnList[0].posYSrc , result.rtnList[0].posXSrc, result.rtnList[0].agencyNm , positions, "mapDiv");
            	} else {
	            	mapDraw(result.rtnList[0].posYSrc , result.rtnList[0].posXSrc, result.rtnList[0].agencyNm , positions, "mapDivPopup");
            	}
            }

		}
	}
}

/*
 * 리퀘스트 후처리 함수 - ERROR
 */
function cfnRequestErrorCallback(callback, status) {
	if(result.rtnCode != 0) {
		if (callback == 'rentalAgencyInfo') {
			// rentalAgencyInfo
			console.log(status);
		} else if (callback == 'selectAroundRentalStoreMap') {
			// selectAroundRentalStoreMap
		}
	}
}

function fn_popupClose() {
	$("#modal-1").removeClass("md-show");
	$('body').removeClass('bgFix');
	// 스크롤이 있는 경우만.
    //$(".scrollBox").hide();
}

/* 나의 위치 근처 렌탈 전문점 가져오기 */
function getRentStore(lat,lon){

	var pUrl = "/order/selectAroundRentalStoreMap";

	var pParams = {
			"posX" : lat
			,"posY" : lon
	};

	console.log("f_searchRentStore  !!!");
	console.log(pParams);
	cfnSendRequest(pUrl,pParams,'selectAroundRentalStoreMap');

}

selectO2o('1');
</script>
